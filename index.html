<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Vibration Live Graph (with Auth - Fixed)</title>

<!-- Firebase + Chart.js -->
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

<style>
  body {
    background: #0f172a;
    color: #f1f5f9;
    font-family: "Segoe UI", sans-serif;
    text-align: center;
    padding: 20px;
  }
  #loginBox {
    background: #1e293b;
    padding: 20px;
    border-radius: 12px;
    display: inline-block;
  }
  input {
    margin: 5px;
    padding: 8px;
    border-radius: 8px;
    border: none;
  }
  button {
    padding: 8px 16px;
    border-radius: 8px;
    background: #38bdf8;
    color: #fff;
    border: none;
    cursor: pointer;
  }
  canvas {
    background: #1e293b;
    border-radius: 12px;
    max-width: 800px;
    margin-top: 20px;
  }
  #alertBox {
    display: none;
    background: #ef4444;
    color: white;
    padding: 10px;
    margin: 10px auto;
    border-radius: 8px;
    width: fit-content;
  }
</style>
</head>

<body>
  <h2>üìà Vibration Live Graph (Last 30 Minutes)</h2>

  <div id="loginBox">
    <h3>Sign in to Firebase</h3>
    <input type="email" id="email" placeholder="Email" value="mjoydeep73@gmail.com"><br>
    <input type="password" id="password" placeholder="Password" value="12345678"><br>
    <button onclick="login()">Login</button>
    <p id="loginStatus"></p>
  </div>

  <div id="graphBox" style="display:none;">
    <div id="alertBox">‚ö†Ô∏è Vibration Detected!</div>
    <canvas id="vibrationChart" width="800" height="400"></canvas>
  </div>

<script>
  // --- Firebase Config ---
  const firebaseConfig = {
    apiKey: "AIzaSyAcb0R8GyyLdSoo3R3jyXtSI6oqy7N-51E",
    databaseURL: "https://vibrationstatus-default-rtdb.asia-southeast1.firebasedatabase.app"
  };
  firebase.initializeApp(firebaseConfig);

  const auth = firebase.auth();
  const db = firebase.database();

  const loginBox = document.getElementById("loginBox");
  const graphBox = document.getElementById("graphBox");
  const alertBox = document.getElementById("alertBox");
  const statusText = document.getElementById("loginStatus");

  let vibrationChart = null; // will hold chart instance

  function login() {
    const email = document.getElementById("email").value;
    const pass = document.getElementById("password").value;

    auth.signInWithEmailAndPassword(email, pass)
      .then(() => {
        statusText.textContent = "‚úÖ Login successful!";
        loginBox.style.display = "none";
        graphBox.style.display = "block";
        startRealtimeChart();
      })
      .catch((err) => {
        statusText.textContent = "‚ùå " + err.message;
      });
  }

  function startRealtimeChart() {
    // Destroy previous chart instance if exists
    if (vibrationChart) {
      vibrationChart.destroy();
      console.log("Destroyed old chart instance");
    }

    // Chart.js setup
    const ctx = document.getElementById('vibrationChart').getContext('2d');
    const chartData = {
      labels: [],
      datasets: [{
        label: 'Vibration (0=Normal, 1=Active)',
        data: [],
        borderColor: '#38bdf8',
        backgroundColor: 'rgba(56,189,248,0.2)',
        borderWidth: 2,
        pointRadius: 3,
        tension: 0.3
      }]
    };
    const chartOptions = {
      animation: false,
      scales: {
        x: { 
          type: 'time',
          time: { unit: 'minute', tooltipFormat: 'HH:mm:ss' },
          ticks: { color: '#cbd5e1' }
        },
        y: { 
          min: -0.2, max: 1.2,
          ticks: { stepSize: 1, color: '#cbd5e1' }
        }
      },
      plugins: {
        legend: { labels: { color: '#f1f5f9' } }
      }
    };

    // Create chart safely
    vibrationChart = new Chart(ctx, { type: 'line', data: chartData, options: chartOptions });
    const WINDOW_MS = 30 * 60 * 1000; // 30 min

    const updateChart = (vibValue) => {
      const now = new Date();
      chartData.labels.push(now);
      chartData.datasets[0].data.push(vibValue);

      // Keep last 30 minutes of data
      while (chartData.labels.length && (now - chartData.labels[0]) > WINDOW_MS) {
        chartData.labels.shift();
        chartData.datasets[0].data.shift();
      }

      // Color change + alert box
      if (vibValue === 1) {
        chartData.datasets[0].borderColor = '#f87171';
        chartData.datasets[0].backgroundColor = 'rgba(248,113,113,0.2)';
        alertBox.style.display = 'block';
      } else {
        chartData.datasets[0].borderColor = '#38bdf8';
        chartData.datasets[0].backgroundColor = 'rgba(56,189,248,0.2)';
        alertBox.style.display = 'none';
      }

      vibrationChart.update();
    };

    // Firebase listener
    const ref = db.ref("vibration/latest");
    ref.off(); // prevent multiple subscriptions
    ref.on("value", (snapshot) => {
      const data = snapshot.val();
      if (data && typeof data.vibration !== 'undefined') {
        console.log("Firebase update:", data);
        updateChart(Number(data.vibration));
      }
    });
  }
</script>
</body>
</html>
