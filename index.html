<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Live Vibration Dashboard</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1"></script>
  <style>
    body { font-family: Arial; margin: 30px; }
    canvas { max-width: 1000px; }
  </style>
</head>
<body>
  <h2>Live Vibration Dashboard (Last 24 Hours)</h2>
  <canvas id="vibrationChart"></canvas>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAcb0R8GyyLdSoo3R3jyXtSI6oqy7N-51E",
      authDomain: "vibrationstatus.firebaseapp.com",
      databaseURL: "https://vibrationstatus-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "vibrationstatus",
    };
   
  firebase.initializeApp(firebaseConfig);
  const database = firebase.database();
  const vibrationRef = database.ref("vibration");

  const ctx = document.getElementById('vibrationChart').getContext('2d');

const data = {
  datasets: [{
    label: 'Vibration',
    data: [],
    borderColor: 'rgb(75,192,192)',
    backgroundColor: 'rgba(75,192,192,0.2)',
    pointRadius: 2,
    fill: false,
    tension: 0.1
  }]
};

const config = {
  type: 'line',
  data: data,
  options: {
    animation: false,
    parsing: false,
    normalized: true,
    scales: {
      x: {
        type: 'time',
        time: {
          unit: 'hour',
          tooltipFormat: 'HH:mm:ss',
          displayFormats: { hour: 'HH:mm' }
        },
        adapters: { date: { zone: 'Asia/Kolkata' } },
        title: { display: true, text: 'Time (IST)' }
      },
      y: {
        min: 0,
        max: 1,
        title: { display: true, text: 'Vibration (0/1)' }
      }
    },
    plugins: { legend: { display: true } }
  }
};

const myChart = new Chart(ctx, config);

const last24Hours = Date.now() - 24*60*60*1000; // 24 hours in ms

vibrationRef.on('child_added', snapshot => {
  const val = snapshot.val();
  if(val.timestamp >= last24Hours) {
    const point = { x: new Date(val.timestamp), y: val.value };
    data.datasets[0].data.push(point);

    // Keep only last 24 hours
    const cutoff = Date.now() - 24*60*60*1000;
    data.datasets[0].data = data.datasets[0].data.filter(p => p.x >= cutoff);

    myChart.update();
  }
});

vibrationRef.once('value', snapshot => {
    const points = [];
    snapshot.forEach(child => {
      const val = child.val();
      if(val.timestamp >= last24Hours) {
        points.push({ x: new Date(val.timestamp), y: val.value });
      }
    });
    points.sort((a,b) => a.x - b.x);
    data.datasets[0].data = points;
    myChart.update();
  });

  </script>
</body>
</html>
