<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Vibration Live Graph (Secure)</title>

<!-- Firebase + Chart.js -->
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  body {
    background: #0f172a;
    color: #f1f5f9;
    font-family: "Segoe UI", sans-serif;
    text-align: center;
    padding: 20px;
  }
  #loginContainer, #chartContainer {
    display: none;
    max-width: 800px;
    margin: auto;
  }
  input {
    padding: 10px;
    margin: 5px;
    border-radius: 6px;
    border: none;
    width: 90%;
    font-size: 1em;
  }
  button {
    padding: 10px 16px;
    background: #38bdf8;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    margin-top: 10px;
  }
  button:hover { background: #0ea5e9; }
  canvas {
    background: #1e293b;
    border-radius: 12px;
    width: 100%;
    margin-top: 20px;
  }
</style>
</head>
<body>

  <h2>üìä Secure Vibration Monitoring Dashboard</h2>

  <!-- Login Section -->
  <div id="loginContainer">
    <h3>üîê Login Required</h3>
    <input type="email" id="email" placeholder="Email" value="mjoydeep73@gmail.com"><br>
    <input type="password" id="password" placeholder="Password" value="12345678"><br>
    <button onclick="login()">Login</button>
    <p id="loginStatus"></p>
  </div>

  <!-- Chart Section -->
  <div id="chartContainer">
    <p>‚úÖ Logged in as <span id="userEmail"></span> 
      <button onclick="logout()">Logout</button>
    </p>
    <canvas id="vibrationChart" width="800" height="400"></canvas>
  </div>

<script>
  // --- Firebase Config ---
  const firebaseConfig = {
  apiKey: "AIzaSyAcb0R8GyyLdSoo3R3jyXtSI6oqy7N-51E",
  authDomain: "vibrationstatus.firebaseapp.com",
  databaseURL: "https://vibrationstatus-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "vibrationstatus",
  storageBucket: "vibrationstatus.firebasestorage.app",
  messagingSenderId: "1001204540193",
  appId: "1:1001204540193:web:79495c246902bee191d460",
  measurementId: "G-RYDGS81ZHW"
};

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  // --- Login/Logout ---
  function login() {
    const email = document.getElementById("email").value;
    const password = document.getElementById("password").value;
    firebase.auth().signInWithEmailAndPassword(email, password)
      .then(() => {
        document.getElementById("loginStatus").textContent = "‚úÖ Login successful!";
      })
      .catch(error => {
        document.getElementById("loginStatus").textContent = "‚ùå " + error.message;
      });
  }

  function logout() {
    firebase.auth().signOut();
  }

  // --- Auth state listener ---
  firebase.auth().onAuthStateChanged(user => {
    if (user) {
      document.getElementById("loginContainer").style.display = "none";
      document.getElementById("chartContainer").style.display = "block";
      document.getElementById("userEmail").textContent = user.email;
      startRealtimeChart();
    } else {
      document.getElementById("loginContainer").style.display = "block";
      document.getElementById("chartContainer").style.display = "none";
    }
  });

  // --- Chart.js Setup ---
  let vibrationChart;
  const chartData = { labels: [], datasets: [{
    label: 'Vibration (0=Normal, 1=Active)',
    data: [],
    borderColor: '#38bdf8',
    borderWidth: 2,
    pointRadius: 3,
    backgroundColor: 'rgba(56,189,248,0.2)',
    tension: 0.3
  }]};

  const chartOptions = {
    animation: false,
    scales: {
      x: { 
        type: 'time',
        time: { unit: 'minute', tooltipFormat: 'HH:mm:ss' },
        ticks: { color: '#cbd5e1' }
      },
      y: { 
        min: -0.2, max: 1.2,
        ticks: { stepSize: 1, color: '#cbd5e1' }
      }
    },
    plugins: {
      legend: { labels: { color: '#f1f5f9' } }
    }
  };

  // --- Realtime Chart Setup ---
  const WINDOW_MS = 30 * 60 * 1000; // 30 minutes

  function startRealtimeChart() {
    if (!vibrationChart) {
      const ctx = document.getElementById('vibrationChart').getContext('2d');
      vibrationChart = new Chart(ctx, { type: 'line', data: chartData, options: chartOptions });
    }

    const ref = db.ref("vibration/latest");
    ref.on("value", (snapshot) => {
      const data = snapshot.val();
      if (data && typeof data.vibration !== 'undefined') {
        const vib = Number(data.vibration);
        const now = new Date();

        chartData.labels.push(now);
        chartData.datasets[0].data.push(vib);

        // Keep only last 30 minutes
        while (chartData.labels.length && (now - chartData.labels[0]) > WINDOW_MS) {
          chartData.labels.shift();
          chartData.datasets[0].data.shift();
        }

        // Dynamic color: red when vibration=1, blue when normal
        if (vib === 1) {
          chartData.datasets[0].borderColor = '#f87171';
          chartData.datasets[0].backgroundColor = 'rgba(248,113,113,0.2)';
        } else {
          chartData.datasets[0].borderColor = '#38bdf8';
          chartData.datasets[0].backgroundColor = 'rgba(56,189,248,0.2)';
        }

        vibrationChart.update();
      }
    });
  }
</script>
</body>
</html>
