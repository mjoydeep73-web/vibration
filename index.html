<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Vibration Sensor Realtime Graph</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: #121212;
      color: #f1f1f1;
      text-align: center;
      margin: 0;
      padding: 30px;
    }
    canvas {
      background: #1e1e1e;
      border-radius: 10px;
      max-width: 900px;
      width: 95%;
      margin-top: 20px;
    }
    #login {
      margin-top: 20px;
    }
    input {
      padding: 8px;
      margin: 5px;
      border-radius: 5px;
      border: none;
    }
    button {
      padding: 8px 14px;
      background: #0078ff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover { background: #005ed6; }

    #status {
      display: inline-block;
      margin-top: 10px;
      font-size: 16px;
      font-weight: 500;
    }
    #dot {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 6px;
      background: gray;
    }
  </style>
</head>
<body>
  <h2>ðŸ“ˆ Vibration Sensor â€” Live + Last 50</h2>

  <!-- Connection Indicator -->
  <div id="status"><span id="dot"></span><span id="stateText">Disconnected</span></div>

  <div id="login">
    <input type="email" id="email" placeholder="Email" value="mjoydeep73@gmail.com">
    <input type="password" id="password" placeholder="Password" value="12345678">
    <button onclick="login()">Login</button>
  </div>

  <canvas id="vibrationChart" height="400"></canvas>

  <script>
    // --- Firebase Config ---
    const firebaseConfig = {
  apiKey: "AIzaSyAcb0R8GyyLdSoo3R3jyXtSI6oqy7N-51E",
  authDomain: "vibrationstatus.firebaseapp.com",
  databaseURL: "https://vibrationstatus-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "vibrationstatus",
  storageBucket: "vibrationstatus.firebasestorage.app",
  messagingSenderId: "1001204540193",
  appId: "1:1001204540193:web:79495c246902bee191d460",
  measurementId: "G-RYDGS81ZHW"
};
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    let chart;
    let labels = [];
    let dataPoints = [];
    let connected = false;
    let latestRef;

    // --- Status Indicator ---
    function setStatus(isConnected) {
      const dot = document.getElementById('dot');
      const text = document.getElementById('stateText');
      if (isConnected) {
        dot.style.background = 'limegreen';
        text.textContent = 'Connected';
      } else {
        dot.style.background = 'red';
        text.textContent = 'Disconnected';
      }
    }

    // --- Chart Setup ---
    function createChart() {
      const ctx = document.getElementById('vibrationChart').getContext('2d');
      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Vibration (1 = Active)',
            data: dataPoints,
            borderColor: '#00e5ff',
            borderWidth: 2,
            fill: false,
            pointRadius: 2
          }]
        },
        options: {
          scales: {
            x: { title: { display: true, text: 'Time (Local)' } },
            y: {
              min: 0, max: 1,
              ticks: { stepSize: 1 },
              title: { display: true, text: 'State' }
            }
          },
          animation: false,
          plugins: {
            legend: { labels: { color: 'white' } }
          }
        }
      });
    }

    // --- Convert UNIX to local readable time ---
    function formatTime(ts) {
      const date = new Date(ts * 1000);
      return date.toLocaleTimeString();
    }

    // --- Load last 50 records from history ---
    function loadHistory() {
      db.ref("vibration/history").limitToLast(50).once("value", (snapshot) => {
        labels.length = 0;
        dataPoints.length = 0;
        snapshot.forEach((child) => {
          const val = child.val();
          labels.push(formatTime(val.ts));
          dataPoints.push(val.vibration);
        });
        chart.update();
        console.log("Loaded history");
      });
    }

    // --- Start realtime updates ---
    function startRealtime() {
      latestRef = db.ref("vibration/latest");
      latestRef.on("value", (snapshot) => {
        const val = snapshot.val();
        if (val) {
          setStatus(true);
          connected = true;

          const time = formatTime(val.ts);
          labels.push(time);
          dataPoints.push(val.vibration);

          if (labels.length > 50) {
            labels.shift();
            dataPoints.shift();
          }
          chart.update();
        }
      }, (error) => {
        console.error("Realtime error:", error);
        setStatus(false);
        connected = false;
      });
    }

    // --- Monitor connection state ---
    db.ref(".info/connected").on("value", (snap) => {
      if (snap.val() === true) {
        setStatus(true);
        connected = true;
      } else {
        setStatus(false);
        connected = false;
      }
    });

    // --- Login & start ---
    function login() {
      const email = document.getElementById('email').value;
      const pass = document.getElementById('password').value;

      auth.signInWithEmailAndPassword(email, pass)
        .then(() => {
          document.getElementById('login').style.display = 'none';
          createChart();
          loadHistory();
          startRealtime();
          setStatus(true);
        })
        .catch((error) => {
          alert("Login failed: " + error.message);
        });
    }

    // --- Reconnect check ---
    setInterval(() => {
      if (!connected) setStatus(false);
    }, 5000);
  </script>
</body>
</html>
